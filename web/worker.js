let wasmModules=[],modelName,modelBuffers;function loadWASMModule(e){try{importScripts("demucs_onnx_simd.js"),wasmModules=Array(e).fill().map(()=>libdemucs())}catch(e){console.error("Error loading WASM module script:",e)}}function getNumModelsFromModelName(){let e=0;return"demucs-free-4s"===modelName||"demucs-free-6s"===modelName||"demucs-karaoke"===modelName?e=1:"demucs-pro-ft"===modelName||"demucs-pro-deluxe"===modelName?e=4:"demucs-pro-cust"===modelName&&(e=3),e}function processAudio(r,a,o,t,n,m){console.log("Started demix job at "+(new Date).toString());var E=o._malloc(r.length*r.BYTES_PER_ELEMENT),_=(new Float32Array(o.HEAPF32.buffer,E,r.length).set(r),o._malloc(a.length*a.BYTES_PER_ELEMENT));if(new Float32Array(o.HEAPF32.buffer,_,a.length).set(a),"demucs-free-4s"===modelName||"demucs-pro-ft"===modelName||"demucs-pro-deluxe"===modelName)return a=o._malloc(r.length*r.BYTES_PER_ELEMENT),f=o._malloc(r.length*r.BYTES_PER_ELEMENT),u=o._malloc(r.length*r.BYTES_PER_ELEMENT),F=o._malloc(r.length*r.BYTES_PER_ELEMENT),d=o._malloc(r.length*r.BYTES_PER_ELEMENT),A=o._malloc(r.length*r.BYTES_PER_ELEMENT),s=o._malloc(r.length*r.BYTES_PER_ELEMENT),g=o._malloc(r.length*r.BYTES_PER_ELEMENT),o._modelDemixSegment(E,_,r.length,f,A,a,d,u,s,F,g,null,null,null,null,t,n,m),c=new Float32Array(o.HEAPF32.buffer,a,r.length),y=new Float32Array(o.HEAPF32.buffer,f,r.length),N=new Float32Array(o.HEAPF32.buffer,u,r.length),i=new Float32Array(o.HEAPF32.buffer,F,r.length),w=new Float32Array(o.HEAPF32.buffer,d,r.length),h=new Float32Array(o.HEAPF32.buffer,A,r.length),P=new Float32Array(o.HEAPF32.buffer,s,r.length),S=new Float32Array(o.HEAPF32.buffer,g,r.length),o._free(E),o._free(_),o._free(a),o._free(d),o._free(f),o._free(A),o._free(u),o._free(s),o._free(F),o._free(g),console.log("Finished demix job at "+(new Date).toString()),[new Float32Array(c),new Float32Array(w),new Float32Array(y),new Float32Array(h),new Float32Array(N),new Float32Array(P),new Float32Array(i),new Float32Array(S)];if("demucs-free-6s"===modelName||"demucs-pro-cust"===modelName){var a=o._malloc(r.length*r.BYTES_PER_ELEMENT),d=o._malloc(r.length*r.BYTES_PER_ELEMENT),f=o._malloc(r.length*r.BYTES_PER_ELEMENT),A=o._malloc(r.length*r.BYTES_PER_ELEMENT),u=o._malloc(r.length*r.BYTES_PER_ELEMENT),s=o._malloc(r.length*r.BYTES_PER_ELEMENT),F=o._malloc(r.length*r.BYTES_PER_ELEMENT),g=o._malloc(r.length*r.BYTES_PER_ELEMENT),c=o._malloc(r.length*r.BYTES_PER_ELEMENT),w=o._malloc(r.length*r.BYTES_PER_ELEMENT),y=o._malloc(r.length*r.BYTES_PER_ELEMENT),h=o._malloc(r.length*r.BYTES_PER_ELEMENT),N=(o._modelDemixSegment(E,_,r.length,d,s,a,u,f,F,A,g,c,w,y,h,t,n,m),new Float32Array(o.HEAPF32.buffer,a,r.length)),P=new Float32Array(o.HEAPF32.buffer,d,r.length),i=new Float32Array(o.HEAPF32.buffer,f,r.length),S=new Float32Array(o.HEAPF32.buffer,A,r.length),T=new Float32Array(o.HEAPF32.buffer,u,r.length),M=new Float32Array(o.HEAPF32.buffer,s,r.length),b=new Float32Array(o.HEAPF32.buffer,F,r.length),R=new Float32Array(o.HEAPF32.buffer,g,r.length),L=new Float32Array(o.HEAPF32.buffer,c,r.length),p=new Float32Array(o.HEAPF32.buffer,w,r.length),B=new Float32Array(o.HEAPF32.buffer,y,r.length),H=new Float32Array(o.HEAPF32.buffer,h,r.length);let e=null,l=null;return"demucs-pro-cust"===modelName&&(e=new Float32Array(o.HEAPF32.buffer,arrayPointerLMelody,r.length),l=new Float32Array(o.HEAPF32.buffer,arrayPointerRMelody,r.length)),o._free(E),o._free(_),o._free(a),o._free(u),o._free(d),o._free(s),o._free(f),o._free(F),o._free(A),o._free(g),o._free(c),o._free(w),o._free(y),o._free(h),"demucs-pro-cust"===modelName&&(o._free(arrayPointerLMelody),o._free(arrayPointerRMelody)),"demucs-free-6s"===modelName?(console.log("Finished demix job at "+(new Date).toString()),[new Float32Array(N),new Float32Array(T),new Float32Array(P),new Float32Array(M),new Float32Array(i),new Float32Array(b),new Float32Array(S),new Float32Array(R),new Float32Array(L),new Float32Array(p),new Float32Array(B),new Float32Array(H)]):"demucs-pro-cust"===modelName?(console.log("Finished demix job at "+(new Date).toString()),[new Float32Array(N),new Float32Array(T),new Float32Array(P),new Float32Array(M),new Float32Array(i),new Float32Array(b),new Float32Array(S),new Float32Array(R),new Float32Array(L),new Float32Array(p),new Float32Array(B),new Float32Array(H),new Float32Array(e),new Float32Array(l)]):void 0}if("demucs-karaoke"===modelName)return a=o._malloc(r.length*r.BYTES_PER_ELEMENT),u=o._malloc(r.length*r.BYTES_PER_ELEMENT),d=o._malloc(r.length*r.BYTES_PER_ELEMENT),s=o._malloc(r.length*r.BYTES_PER_ELEMENT),o._modelDemixSegment(E,_,r.length,a,d,u,s,null,null,null,null,null,null,null,null,t,n,m),f=new Float32Array(o.HEAPF32.buffer,a,r.length),F=new Float32Array(o.HEAPF32.buffer,u,r.length),A=new Float32Array(o.HEAPF32.buffer,d,r.length),g=new Float32Array(o.HEAPF32.buffer,s,r.length),o._free(E),o._free(_),o._free(a),o._free(d),o._free(u),o._free(s),console.log("Finished demix job at "+(new Date).toString()),[new Float32Array(f),new Float32Array(A),new Float32Array(F),new Float32Array(g)];console.error("Unsupported model name:",modelName)}onmessage=function(d){if("LOAD_WASM"===d.data.msg)modelName=d.data.model,modelBuffers=d.data.modelBuffers,loadWASMModule(getNumModelsFromModelName());else if("PROCESS_AUDIO"===d.data.msg||"PROCESS_AUDIO_BATCH"===d.data.msg){let t=d.data.leftChannel,n=d.data.rightChannel,m=getNumModelsFromModelName();"demucs-pro-deluxe"!==modelName&&"demucs-pro-cust"!==modelName&&modelName;let E=[],_=modelBuffers.map(e=>new Uint8Array(e));Promise.all(wasmModules).then(async r=>{let a=_.map((e,l)=>r[l]._malloc(e.byteLength));if(_.forEach((e,l)=>r[l].HEAPU8.set(e,a[l])),"demucs-pro-cust"!=modelName)for(let l=0;l<m;l++){var o=await r[l];console.log(`Loading wasm module for model ${modelName} with len `+_[l].byteLength),o._modelInit(a[l],_[l].byteLength),o._free(a[l]);let e;"PROCESS_AUDIO"===d.data.msg?e=await processAudio(t,n,o,!1,m,l):"PROCESS_AUDIO_BATCH"===d.data.msg&&(e=await processAudio(t,n,o,!0,m,l)),E.push(e)}else console.error("Unsupported model name:",modelName)}).then(()=>{console.log(E);let e;"demucs-karaoke"===modelName||"demucs-free-4s"===modelName||"demucs-free-6s"===modelName?e=E[0]:"demucs-pro-ft"===modelName||"demucs-pro-deluxe"===modelName?((e=E[0])[0]=E[0][1],e[1]=E[1][1],e[2]=E[2][1],e[3]=E[3][1]):"demucs-pro-cust"===modelName&&console.error("Unsupported model name:",modelName);var l=e.map(e=>e.buffer);postMessage({msg:"PROCESS_AUDIO"===d.data.msg?"PROCESSING_DONE":"PROCESSING_DONE_BATCH",waveforms:e,originalLength:d.data.originalLength,filename:"PROCESS_AUDIO"===d.data.msg?"":d.data.filename},l)})}};