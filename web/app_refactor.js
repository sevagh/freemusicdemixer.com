function sumSegments(e,s,c){let d=s;let l=e[0][0].length-2*c,m=new Array(e[0].length).fill().map(()=>new Float32Array(d));var t=new Float32Array(l);for(let e=0;e<l;e++)t[e]=e+1,t[l-1-e]=e+1;let u=t.reduce((e,s)=>Math.max(e,s),-1/0),o=t.map(e=>e/u),a=new Float32Array(d).fill(0);e.forEach((e,s)=>{var t=s*l;for(let s=0;s<e.length;s++){var u=e[s];for(let e=0;e<u.length;e++){var r=t+(e-c);0<=r&&r<d&&(m[s][r]+=o[e%l]*u[e],a[r]+=o[e%l])}}});for(let s=0;s<m.length;s++)for(let e=0;e<d;e++)0!==a[e]&&(m[s][e]/=a[e]/m.length);return m}function segmentWaveform(s,t,u,r){var c=s.length,d=Math.ceil(c/u),l=[];for(let e=0;e<u;e++){var m,o=e*d,a=Math.min(c,o+d),n=new Float32Array(a-o+2*r),i=new Float32Array(a-o+2*r);0===e?(n.fill(s[0],0,r),i.fill(t[0],0,r)):(n.set(s.slice(o-r,o),0),i.set(t.slice(o-r,o),0)),e===u-1?(m=c-a,n.set(s.slice(a,a+Math.min(r,m)),a-o+r),i.set(t.slice(a,a+Math.min(r,m)),a-o+r)):(n.set(s.slice(a,a+r),a-o+r),i.set(t.slice(a,a+r),a-o+r)),n.set(s.slice(o,a),r),i.set(t.slice(o,a),r),l.push([n,i])}return l}function processSegments(t,e,s,u,r,c,d=null){segmentWaveform(e,s,u,c).forEach((e,s)=>{t[s].postMessage({msg:d?"PROCESS_AUDIO_BATCH":"PROCESS_AUDIO",leftChannel:e[0],rightChannel:e[1],originalLength:r,...d&&{filename:d}})})}function fetchAndCacheFiles(e,s,t="https://bucket.freemusicdemixer.com"){let u=[];"demucs-free-4s"===e?u.push("htdemucs.ort.gz"):"demucs-free-6s"===e?u.push("htdemucs_6s.ort.gz"):"demucs-karaoke"===e?u.push("htdemucs_2s_cust.ort.gz"):"demucs-pro-ft"===e||"demucs-pro-deluxe"===e?(s.includes("drums")&&u.push("htdemucs_ft_drums.ort.gz"),s.includes("bass")&&u.push("htdemucs_ft_bass.ort.gz"),s.includes("melody")&&u.push("htdemucs_ft_other.ort.gz"),s.includes("vocals")&&u.push("demucs-pro-ft"===e?"htdemucs_ft_vocals.ort.gz":"htdemucs_2s_cust.ort.gz")):"demucs-pro-cust"===e?(u.push("htdemucs_ft_vocals.ort.gz"),u.push("htdemucs_6s.ort.gz")):"demucs-pro-cust-spec"===e&&(u.push("htdemucs_2s_cust.ort.gz"),u.push("htdemucs_ft_drums.ort.gz"),u.push("htdemucs_ft_bass.ort.gz"),u.push("htdemucs_6s.ort.gz"));s=(u=u.map(e=>t+"/"+e)).map(s=>fetch(s).then(e=>{if(e.ok)return e.arrayBuffer();throw new Error("Failed to fetch "+s)}));return Promise.all(s)}function computeModelAndStems(e,s,t){if("midi"===e)return{model:"basicpitch",stems:[]};let u="4-SOURCE (FREE)",r=(s.includes("piano")||s.includes("guitar")||s.includes("other_melody")?"default"===t?u="6-SOURCE (PRO)":"medium"===t?u="CUSTOM (PRO)":"high"===t&&(u="CUSTOM SPECIAL (PRO)"):s.every(e=>["vocals","instrumental"].includes(e))?"default"===t?u="4-SOURCE (FREE)":"medium"===t?u="FINE-TUNED (PRO)":"high"===t&&(u="KARAOKE (PRO)"):s.some(e=>["vocals","drums","bass","melody"].includes(e))&&("default"===t?u="4-SOURCE (FREE)":"medium"===t?u="FINE-TUNED (PRO)":"high"===t&&(u="DELUXE (PRO)")),"");switch(u){case"4-SOURCE (FREE)":r="demucs-free-4s";break;case"6-SOURCE (PRO)":r="demucs-free-6s";break;case"FINE-TUNED (PRO)":r="demucs-pro-ft";break;case"KARAOKE (PRO)":r="demucs-karaoke";break;case"CUSTOM (PRO)":r="demucs-pro-cust";break;case"DELUXE (PRO)":r="demucs-pro-deluxe";break;case"CUSTOM SPECIAL (PRO)":r="demucs-pro-cust-spec"}e=[...s];return e.includes("instrumental")&&"demucs-karaoke"!==r&&(["demucs-free-4s","demucs-pro-ft","demucs-pro-deluxe"].includes(r)&&(e.includes("drums")||e.push("drums"),e.includes("bass")||e.push("bass"),e.includes("melody")||e.push("melody")),["demucs-free-6s","demucs-pro-cust","demucs-pro-cust-spec"].includes(r))&&(e.includes("drums")||e.push("drums"),e.includes("bass")||e.push("bass"),e.includes("other_melody")||e.push("other_melody"),e.includes("guitar")||e.push("guitar"),e.includes("piano")||e.push("piano")),e.includes("melody")&&["demucs-free-6s","demucs-pro-cust","demucs-pro-cust-spec"].includes(r)&&(e.includes("other_melody")||e.push("other_melody"),e.includes("guitar")||e.push("guitar"),e.includes("piano")||e.push("piano")),e.sort((e,s)=>{var t=["drums","bass","melody","vocals","guitar","piano","instrumental"];return t.indexOf(e)-t.indexOf(s)}),{model:r,stems:e}}export{sumSegments,processSegments,fetchAndCacheFiles,computeModelAndStems};