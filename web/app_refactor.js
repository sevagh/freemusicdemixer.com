function sumSegments(e,t){let c=t;let l=e[0][0].length-2*DEMUCS_OVERLAP_SAMPLES,h=new Array(e[0].length).fill().map(()=>new Float32Array(c));var s=new Float32Array(l);for(let e=0;e<l;e++)s[e]=e+1,s[l-1-e]=e+1;let r=s.reduce((e,t)=>Math.max(e,t),-1/0),o=s.map(e=>e/r),a=new Float32Array(c).fill(0);e.forEach((e,t)=>{var s=t*l;for(let t=0;t<e.length;t++){var r=e[t];for(let e=0;e<r.length;e++){var u=s+(e-DEMUCS_OVERLAP_SAMPLES);0<=u&&u<c&&(h[t][u]+=o[e%l]*r[e],a[u]+=o[e%l])}}});for(let t=0;t<h.length;t++)for(let e=0;e<c;e++)0!==a[e]&&(h[t][e]/=a[e]/h.length);return h}function segmentWaveform(t,s,r,u){var c=t.length,l=Math.ceil(c/r),h=[];for(let e=0;e<r;e++){var o,a=e*l,m=Math.min(c,a+l),n=new Float32Array(m-a+2*u),f=new Float32Array(m-a+2*u);0===e?(n.fill(t[0],0,u),f.fill(s[0],0,u)):(n.set(t.slice(a-u,a),0),f.set(s.slice(a-u,a),0)),e===r-1?(o=c-m,n.set(t.slice(m,m+Math.min(u,o)),m-a+u),f.set(s.slice(m,m+Math.min(u,o)),m-a+u)):(n.set(t.slice(m,m+u),m-a+u),f.set(s.slice(m,m+u),m-a+u)),n.set(t.slice(a,m),u),f.set(s.slice(a,m),u),h.push([n,f])}return h}function processSegments(s,e,t,r,u,c,l=null){segmentWaveform(e,t,r,c).forEach((e,t)=>{s[t].postMessage({msg:l?"PROCESS_AUDIO_BATCH":"PROCESS_AUDIO",leftChannel:e[0],rightChannel:e[1],originalLength:u,...l&&{filename:l}})})}function fetchAndCacheFiles(e,t,s="https://bucket.freemusicdemixer.com"){let r=[];"demucs-free-4s"===e?r.push("htdemucs.ort.gz"):"demucs-free-6s"===e?r.push("htdemucs_6s.ort.gz"):"demucs-karaoke"===e?r.push("htdemucs_2s_cust.ort.gz"):"demucs-pro-ft"===e||"demucs-pro-deluxe"===e?(t.includes("drums")&&r.push("htdemucs_ft_drums.ort.gz"),t.includes("bass")&&r.push("htdemucs_ft_bass.ort.gz"),t.includes("melody")&&r.push("htdemucs_ft_other.ort.gz"),t.includes("vocals")&&r.push("demucs-pro-ft"===e?"htdemucs_ft_vocals.ort.gz":"htdemucs_2s_cust.ort.gz")):"demucs-pro-cust"===e?(r.push("htdemucs_ft_vocals.ort.gz"),r.push("htdemucs_6s.ort.gz")):"demucs-pro-cust-spec"===e&&(r.push("htdemucs_2s_cust.ort.gz"),r.push("htdemucs_ft_drums.ort.gz"),r.push("htdemucs_ft_bass.ort.gz"),r.push("htdemucs_6s.ort.gz"));t=(r=r.map(e=>s+"/"+e)).map(t=>fetch(t).then(e=>{if(e.ok)return e.arrayBuffer();throw new Error("Failed to fetch "+t)}));return Promise.all(t)}export{sumSegments,processSegments,fetchAndCacheFiles};