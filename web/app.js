import{encodeWavFileFromAudioBuffer}from"./WavFileEncoder.js";let componentsCheckboxes=document.querySelectorAll('#modelPickerForm input[type="checkbox"]'),qualityRadios=document.querySelectorAll('#qualityPickerForm input[type="radio"]'),memoryRadios=document.querySelectorAll('#memorySelectorForm input[type="radio"]');qualityRadios.forEach(e=>e.addEventListener("change",updateModelBasedOnSelection));let selectedModel,selectedStems,processingMode=(componentsCheckboxes.forEach(t=>{t.addEventListener("change",()=>{var e=document.querySelectorAll('#modelPickerForm input[type="checkbox"]:not([disabled])');0===Array.from(e).filter(e=>e.checked).length&&(t.checked=!0),updateModelBasedOnSelection()})}),"stems"),NUM_WORKERS=(document.getElementById("processingPickerForm").addEventListener("change",e=>{let t=document.getElementById("midi").checked;var n=document.getElementById("both").checked,s="true"===sessionStorage.getItem("loggedIn");let o=0;0===(o=!s||-1!==(o=parseInt(sessionStorage.getItem("userTier")))&&!isNaN(o)?o:0)?["vocals","drums","bass","melody","instrumental","piano","guitar","other_melody","default-quality"].forEach(e=>{document.getElementById(e).disabled=t}):2===o&&qualityRadios.forEach(e=>e.disabled=t),memoryRadios.forEach(e=>e.disabled=t);s=document.getElementById("advancedSettings");t&&(s.style.display="none");let l="",i="";i=t?(processingMode="midi",l="none","block"):n?(processingMode="both",l="block"):(processingMode="stems",l="block","none"),document.getElementById("inference-progress-bar").style.display=l,document.getElementById("inference-progress-text").style.display=l,document.getElementById("inference-progress-bar-outer").style.display=l,document.getElementById("midi-progress-bar").style.display=i,document.getElementById("midi-progress-text").style.display=i,document.getElementById("midi-progress-bar-outer").style.display=i,console.log("Setting processing mode to:",processingMode),updateModelBasedOnSelection()}),4),workers,workerProgress,dlModelBuffers,jobRunning=!1,processedSegments=new Array(NUM_WORKERS),completedSegments=0,completedSongsBatch=0,batchNextFileResolveCallback=null,globalProgressIncrement=0,DEMUCS_SAMPLE_RATE=44100,DEMUCS_OVERLAP_S=.75,DEMUCS_OVERLAP_SAMPLES=Math.floor(DEMUCS_SAMPLE_RATE*DEMUCS_OVERLAP_S),BASICPITCH_SAMPLE_RATE=22050,tierNames={0:"Free",2:"Pro"},dl_prefix="https://bucket.freemusicdemixer.com";function fetchAndCacheFiles(e,t){let n=[];"demucs-free-4s"===e?n.push("htdemucs.ort.gz"):"demucs-free-6s"===e?n.push("htdemucs_6s.ort.gz"):"demucs-karaoke"===e?n.push("htdemucs_2s_cust.ort.gz"):"demucs-pro-ft"===e||"demucs-pro-deluxe"===e?(t.includes("drums")&&n.push("htdemucs_ft_drums.ort.gz"),t.includes("bass")&&n.push("htdemucs_ft_bass.ort.gz"),t.includes("melody")&&n.push("htdemucs_ft_other.ort.gz"),t.includes("vocals")&&n.push("demucs-pro-ft"===e?"htdemucs_ft_vocals.ort.gz":"htdemucs_2s_cust.ort.gz")):"demucs-pro-cust"===e?(n.push("htdemucs_ft_vocals.ort.gz"),n.push("htdemucs_6s.ort.gz")):"demucs-pro-cust-spec"===e&&(n.push("htdemucs_2s_cust.ort.gz"),n.push("htdemucs_ft_drums.ort.gz"),n.push("htdemucs_ft_bass.ort.gz"),n.push("htdemucs_6s.ort.gz"));t=(n=n.map(e=>dl_prefix+"/"+e)).map(t=>fetch(t).then(e=>{if(e.ok)return e.arrayBuffer();throw new Error("Failed to fetch "+t)}));return Promise.all(t)}let fileInput=document.getElementById("audio-upload"),folderInput=document.getElementById("batch-upload"),selectedInputMessage=document.getElementById("selectedInputMessage"),isSingleMode=!0,selectedInput=null,step1=document.getElementById("wizard-step-1"),step2=document.getElementById("wizard-step-2"),step3=document.getElementById("wizard-step-3"),nextStep1Btn=document.getElementById("next-step-1"),nextStep2Btn=document.getElementById("next-step-2"),nextStep3Btn=document.getElementById("next-step-3-sheet-music"),nextStep4Btn=document.getElementById("next-step-4"),prevStep2Btn=document.getElementById("prev-step-2"),prevStep3Btn=document.getElementById("prev-step-3"),prevStep4Btn=document.getElementById("prev-step-4"),usageLimits=document.getElementById("usage-limits"),demucsAudioContext;function getDemucsAudioContext(){return demucsAudioContext=demucsAudioContext||new(window.AudioContext||window.webkitAudioContext)({sampleRate:DEMUCS_SAMPLE_RATE})}let basicpitchAudioContext;function getBasicpitchAudioContext(){return basicpitchAudioContext=basicpitchAudioContext||new(window.AudioContext||window.webkitAudioContext)({sampleRate:BASICPITCH_SAMPLE_RATE})}document.addEventListener("DOMContentLoaded",function(){registerServiceWorker(),resetUIElements()});let registerServiceWorker=async()=>{if("serviceWorker"in navigator)try{var e=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error("Registration failed with "+e)}};function resetUIElements(){document.getElementById("stems").checked=!0,document.getElementById("midi-progress-bar").style.display="none",document.getElementById("midi-progress-text").style.display="none",document.getElementById("midi-progress-bar-outer").style.display="none",document.getElementById("inference-progress-text").style.display="block",document.getElementById("inference-progress-bar").style.display="block",document.getElementById("inference-progress-bar-outer").style.display="block",["vocals","drums","bass","melody","instrumental","piano","guitar","other_melody","default-quality","4gb","8gb","16gb","32gb"].forEach(e=>{document.getElementById(e).disabled=!1}),document.getElementById("medium-quality").disabled=!0,document.querySelector('label[for="medium-quality"]').textContent="Medium ðŸ”’",document.getElementById("high-quality").disabled=!0,document.querySelector('label[for="high-quality"]').textContent="High ðŸ”’",componentsCheckboxes.forEach(e=>e.checked=!1),["vocals","drums","bass","melody","instrumental"].forEach(e=>{document.getElementById(e).checked=!0}),qualityRadios.forEach(e=>e.checked=!1),document.getElementById("default-quality").checked=!0,document.getElementById("8gb").checked=!0,nextStep2Btn.disabled=!0,nextStep3Btn.disabled=!0,prevStep3Btn.disabled=!0,initializeInputState();var e="true"===sessionStorage.getItem("loggedIn");let t=0;activateTierUI(t=!e||-1!==(t=parseInt(sessionStorage.getItem("userTier")))&&!isNaN(t)?t:0)}function updateModelBasedOnSelection(){if(console.log("Updating model based on selection"),"midi"===processingMode)selectedModel="basicpitch";else{var t=Array.from(componentsCheckboxes).filter(e=>e.checked).map(e=>e.value),n=document.querySelector('input[type="radio"][name="quality"]:checked').value;let e="4-SOURCE (FREE)";t.includes("piano")||t.includes("guitar")||t.includes("other_melody")?"default"===n?e="6-SOURCE (PRO)":"medium"===n?e="CUSTOM (PRO)":"high"===n&&(e="CUSTOM SPECIAL (PRO)"):t.every(e=>["vocals","instrumental"].includes(e))?"default"===n?e="4-SOURCE (FREE)":"medium"===n?e="FINE-TUNED (PRO)":"high"===n&&(e="KARAOKE (PRO)"):t.some(e=>["vocals","drums","bass","melody"].includes(e))&&("default"===n?e="4-SOURCE (FREE)":"medium"===n?e="FINE-TUNED (PRO)":"high"===n&&(e="DELUXE (PRO)")),"4-SOURCE (FREE)"===e?selectedModel="demucs-free-4s":"6-SOURCE (PRO)"===e?selectedModel="demucs-free-6s":"FINE-TUNED (PRO)"===e?selectedModel="demucs-pro-ft":"KARAOKE (PRO)"===e?selectedModel="demucs-karaoke":"CUSTOM (PRO)"===e?selectedModel="demucs-pro-cust":"DELUXE (PRO)"===e?selectedModel="demucs-pro-deluxe":"CUSTOM SPECIAL (PRO)"===e&&(selectedModel="demucs-pro-cust-spec"),(selectedStems=t).includes("instrumental")&&"demucs-karaoke"!==selectedModel&&(["demucs-free-4s","demucs-pro-ft","demucs-pro-deluxe"].includes(selectedModel)&&(selectedStems.includes("drums")||selectedStems.push("drums"),selectedStems.includes("bass")||selectedStems.push("bass"),selectedStems.includes("melody")||selectedStems.push("melody")),["demucs-free-6s","demucs-pro-cust","demucs-pro-cust-spec"].includes(selectedModel))&&(selectedStems.includes("drums")||selectedStems.push("drums"),selectedStems.includes("bass")||selectedStems.push("bass"),selectedStems.includes("other_melody")||selectedStems.push("other_melody"),selectedStems.includes("guitar")||selectedStems.push("guitar"),selectedStems.includes("piano")||selectedStems.push("piano")),selectedStems.includes("melody")&&["demucs-free-6s","demucs-pro-cust","demucs-pro-cust-spec"].includes(selectedModel)&&(selectedStems.includes("other_melody")||selectedStems.push("other_melody"),selectedStems.includes("guitar")||selectedStems.push("guitar"),selectedStems.includes("piano")||selectedStems.push("piano")),selectedStems.sort((e,t)=>"drums"===e?-1:"drums"===t?1:"bass"===e?-1:"bass"===t?1:"melody"===e?-1:"melody"===t?1:"vocals"===e?-1:"vocals"===t?1:"guitar"===e?-1:"guitar"===t?1:"piano"===e?-1:"piano"===t?1:"instrumental"===e?-1:"instrumental"===t?1:0)}}function segmentWaveform(t,n,s){var o=t.length,l=Math.ceil(o/s),i=[];for(let e=0;e<s;e++){var d,r=e*l,a=Math.min(o,r+l),c=new Float32Array(a-r+2*DEMUCS_OVERLAP_SAMPLES),u=new Float32Array(a-r+2*DEMUCS_OVERLAP_SAMPLES);0===e?(c.fill(t[0],0,DEMUCS_OVERLAP_SAMPLES),u.fill(n[0],0,DEMUCS_OVERLAP_SAMPLES)):(c.set(t.slice(r-DEMUCS_OVERLAP_SAMPLES,r),0),u.set(n.slice(r-DEMUCS_OVERLAP_SAMPLES,r),0)),e===s-1?(d=o-a,c.set(t.slice(a,a+Math.min(DEMUCS_OVERLAP_SAMPLES,d)),a-r+DEMUCS_OVERLAP_SAMPLES),u.set(n.slice(a,a+Math.min(DEMUCS_OVERLAP_SAMPLES,d)),a-r+DEMUCS_OVERLAP_SAMPLES)):(c.set(t.slice(a,a+DEMUCS_OVERLAP_SAMPLES),a-r+DEMUCS_OVERLAP_SAMPLES),u.set(n.slice(a,a+DEMUCS_OVERLAP_SAMPLES),a-r+DEMUCS_OVERLAP_SAMPLES)),c.set(t.slice(r,a),DEMUCS_OVERLAP_SAMPLES),u.set(n.slice(r,a),DEMUCS_OVERLAP_SAMPLES),i.push([c,u])}return i}function sumSegments(e,t){let l=t;let i=e[0][0].length-2*DEMUCS_OVERLAP_SAMPLES,d=new Array(e[0].length).fill().map(()=>new Float32Array(l));var n=new Float32Array(i);for(let e=0;e<i;e++)n[e]=e+1,n[i-1-e]=e+1;let s=n.reduce((e,t)=>Math.max(e,t),-1/0),r=n.map(e=>e/s),a=new Float32Array(l).fill(0);e.forEach((e,t)=>{var n=t*i;for(let t=0;t<e.length;t++){var s=e[t];for(let e=0;e<s.length;e++){var o=n+(e-DEMUCS_OVERLAP_SAMPLES);0<=o&&o<l&&(d[t][o]+=r[e%i]*s[e],a[o]+=r[e%i])}}});for(let t=0;t<d.length;t++)for(let e=0;e<l;e++)0!==a[e]&&(d[t][e]/=a[e]/d.length);return d}function initWorkers(){workers&&(workers.forEach(e=>{e.terminate()}),workerProgress=null),workers=new Array(NUM_WORKERS),workerProgress=new Array(NUM_WORKERS).fill(0);for(let s=0;s<NUM_WORKERS;s++)workers[s]=new Worker("worker.js"),workers[s].onmessage=function(e){var t,n;"WASM_READY"!=e.data.msg&&("PROGRESS_UPDATE"===e.data.msg?(workerProgress[s]=e.data.data,n=workerProgress.reduce((e,t)=>e+t,0)/NUM_WORKERS,document.getElementById("inference-progress-bar").style.width=100*n+"%"):"PROGRESS_UPDATE_BATCH"===e.data.msg?(workerProgress[s]=e.data.data,n=workerProgress.reduce((e,t)=>e+t,0)/NUM_WORKERS*globalProgressIncrement,n=completedSongsBatch*globalProgressIncrement+n,document.getElementById("inference-progress-bar").style.width=n+"%"):"PROCESSING_DONE"===e.data.msg?(processedSegments[s]=e.data.waveforms,n=e.data.originalLength,completedSegments+=1,workers[s].terminate(),completedSegments===NUM_WORKERS&&("stems"===processingMode&&incrementUsage(),packageAndDownload(sumSegments(processedSegments,n)),processedSegments=null,completedSegments=0,jobRunning=!1)):"PROCESSING_DONE_BATCH"===e.data.msg?(n=e.data.filename,processedSegments[s]=e.data.waveforms,completedSegments+=1,t=e.data.originalLength,completedSegments===NUM_WORKERS&&("stems"===processingMode&&incrementUsage(),packageAndZip(sumSegments(processedSegments,t),n),completedSegments=0,completedSongsBatch+=1,workerProgress=new Array(NUM_WORKERS).fill(0),batchNextFileResolveCallback&&(batchNextFileResolveCallback(),batchNextFileResolveCallback=null),completedSongsBatch===document.getElementById("batch-upload").files.length)&&(completedSongsBatch=0,workers.forEach(e=>{e.terminate()}),processedSegments=null,jobRunning=!1)):"WASM_ERROR"===e.data.msg&&(console.log("Error executing WASM"),document.getElementById("inference-progress-bar").style.backgroundColor="red",document.getElementById("inference-progress-bar").style.width="100%",t=document.getElementById("output-links"),(n=document.createElement("p")).textContent='âŒ An error occured. Refresh the page and try again with more memory from "Advanced" settings',t.appendChild(n)))},console.log(`Selected model: ${selectedModel}, with stems: `+selectedStems),workers[s].postMessage({msg:"LOAD_WASM",model:selectedModel,stems:selectedStems,modelBuffers:dlModelBuffers});jobRunning=!0}async function initModel(){if("midi"!==processingMode){displayStep2Spinner();try{try{var e=await fetchAndCacheFiles(selectedModel,selectedStems);nextStep3Btn.disabled=!1,dlModelBuffers=e,console.log("Model files downloaded:",e)}catch(e){console.log("Failed to fetch model files:",e)}}finally{removeStep2Spinner()}}}function processAudioSegments(e,t,n,s){segmentWaveform(e,t,n).forEach((e,t)=>{workers[t].postMessage({msg:"PROCESS_AUDIO",leftChannel:e[0],rightChannel:e[1],originalLength:s})})}function processBatchSegments(e,t,n,s,o){segmentWaveform(e,t,n).forEach((e,t)=>{workers[t].postMessage({msg:"PROCESS_AUDIO_BATCH",leftChannel:e[0],rightChannel:e[1],filename:s,originalLength:o})})}function initializeInputState(){0<fileInput.files.length?(isSingleMode=!0,selectedInput=fileInput.files[0],updateSelectedInputMessage()):0<folderInput.files.length&&(isSingleMode=!1,selectedInput=folderInput.files,updateSelectedInputMessage()),toggleNextButton(),checkAndResetWeeklyLimit()}function toggleNextButton(){var e=JSON.parse(localStorage.getItem("weeklyUsage")),e=e?3-e.count:0,t="true"===sessionStorage.getItem("loggedIn");selectedInput&&(t||0<e)?(nextStep2Btn.disabled=!1,nextStep2Btn.textContent="Start job"):(nextStep2Btn.disabled=!0,nextStep2Btn.textContent=e<=0&&!t?"Limit reached":"Start job")}function updateSelectedInputMessage(){isSingleMode&&selectedInput?selectedInputMessage.textContent="Selected input: "+selectedInput.name:!isSingleMode&&selectedInput?selectedInputMessage.textContent=`Selected input: folder with ${selectedInput.length} files`:selectedInputMessage.textContent="Selected input:"}function checkAndResetWeeklyLimit(){let e=JSON.parse(localStorage.getItem("weeklyUsage"));e||(e={count:0,weekStart:(new Date).toISOString()},localStorage.setItem("weeklyUsage",JSON.stringify(e)));var t=new Date(e.weekStart),n=new Date,n=(6048e5<n-t&&(e.count=0,e.weekStart=n.toISOString(),localStorage.setItem("weeklyUsage",JSON.stringify(e))),"true"===sessionStorage.getItem("loggedIn"));n?(usageLimits.textContent="You have unlimited jobs with your PRO subscription!",-1!==(n=parseInt(sessionStorage.getItem("userTier")))&&isNaN(n)):(n=3-e.count,usageLimits.innerHTML=`You have ${n} free jobs remaining this week. Your limit will reset on ${new Date(t.getTime()+6048e5).toLocaleDateString()}. ðŸ”’ <b><a href="/pricing#subscribe-today" target="_blank">Click here to buy unlimited demixes!</a></b>`),toggleNextButton()}function displayStep2Spinner(){console.log("Displaying spinner"),document.getElementById("step2-overlay").style.display="flex",document.getElementById("step2-spinner").style.display="flex",prevStep3Btn.disabled=!0,nextStep3Btn.disabled=!0}function removeStep2Spinner(){document.getElementById("step2-overlay").style.display="none",document.getElementById("step2-spinner").style.display="none",prevStep3Btn.disabled=!1,nextStep3Btn.disabled=!1}function activateTierUI(e){console.log("Enabling UI for user tier:",e),2===e&&(document.getElementById("midi").disabled=!1,document.getElementById("both").disabled=!1,document.querySelector('label[for="both"]').textContent="Stems + music transcription",document.querySelector('label[for="midi"]').textContent="Music transcription only",document.getElementById("medium-quality").disabled=!1,document.getElementById("high-quality").disabled=!1,document.querySelector('label[for="medium-quality"]').textContent="Medium",document.querySelector('label[for="high-quality"]').textContent="High",document.getElementById("response-message").innerHTML=tierNames[e]+' activated. <a class="wizard-link" href="https://billing.stripe.com/p/login/eVacPX8pKexG5tm8ww">Manage your subscription</a>.',document.getElementById("pro-cta").innerHTML="Pro content unlocked!",console.log("PRO-tier UI elements enabled."));var t=document.querySelector("#logo-display img"),n=document.querySelector("#logo-display small");t&&n&&(t.src=tierLogos[e],t.alt=`freemusicdemixer-${tierNames[e].toLowerCase()}-logo`,n.textContent=tierNames[e]+" tier ",n.appendChild(t)),checkAndResetWeeklyLimit()}window.addEventListener("loginSuccess",e=>{console.log("Login success event detected in app.js"),resetUIElements()}),window.addEventListener("beforeunload",e=>{if(jobRunning)return e.preventDefault(),e.returnValue=""}),document.addEventListener("click",function(){var e=getDemucsAudioContext(),e=("suspended"===e.state&&e.resume(),getBasicpitchAudioContext());"suspended"===e.state&&e.resume()}),fileInput.addEventListener("change",function(){0<fileInput.files.length&&(folderInput.value="",isSingleMode=!0,selectedInput=fileInput.files[0],updateSelectedInputMessage()),toggleNextButton(),checkAndResetWeeklyLimit()}),folderInput.addEventListener("change",function(){0<folderInput.files.length&&(fileInput.value="",isSingleMode=!1,selectedInput=folderInput.files,updateSelectedInputMessage()),toggleNextButton()});let toggleButton=document.getElementById("advancedSettingsToggle"),tooltipToggleButton=document.getElementById("midiTooltipToggle"),advancedSettings=document.getElementById("advancedSettings"),tooltipContents=document.getElementById("midiTooltip"),qualitytooltipToggleButton=document.getElementById("qualityTooltipToggle"),qualityTooltipContents=document.getElementById("qualityTooltip"),componenttooltipToggleButton=document.getElementById("componentTooltipToggle"),componentTooltipContents=document.getElementById("componentTooltip"),midiQueue=(componenttooltipToggleButton.addEventListener("click",function(){"none"===componentTooltipContents.style.display?componentTooltipContents.style.display="block":componentTooltipContents.style.display="none"}),toggleButton.addEventListener("click",function(){"none"===advancedSettings.style.display?advancedSettings.style.display="block":advancedSettings.style.display="none"}),tooltipToggleButton.addEventListener("click",function(){"none"===tooltipContents.style.display?tooltipContents.style.display="block":tooltipContents.style.display="none"}),qualitytooltipToggleButton.addEventListener("click",function(){"none"===qualityTooltipContents.style.display?qualityTooltipContents.style.display="block":qualityTooltipContents.style.display="none"}),nextStep1Btn.addEventListener("click",function(){updateModelBasedOnSelection(),trackProductEvent("Chose Model",{model:selectedModel}),step1.style.display="none",step2.style.display="block"}),document.getElementById("activation-form").addEventListener("submit",function(e){e.preventDefault()}),nextStep2Btn.addEventListener("click",function(){console.log("Is single mode:",isSingleMode),console.log("Selected input on next step:",selectedInput),initModel().then(()=>{console.log("Starting demix job"),step3.style.display="block",step2.style.display="none",prevStep3Btn.disabled=!0,nextStep3Btn.disabled=!0;var e=document.querySelector('input[name="memory"]:checked').value,e=parseInt(e)/4;if(NUM_WORKERS=e,processedSegments=new Array(NUM_WORKERS).fill(void 0),isSingleMode){trackProductEvent("Start Job",{mode:"single",numWorkers:e}),"midi"!=processingMode&&initWorkers();var t=new FileReader;t.onload=function(e){document.getElementById("inference-progress-bar").style.width="0%",document.getElementById("midi-progress-bar").style.width="0%";for(var t=document.getElementById("output-links");t.firstChild;)t.removeChild(t.firstChild);e=e.target.result;"midi"!=processingMode?demucsAudioContext.decodeAudioData(e,function(e){let t,n;n=1==e.numberOfChannels?(t=e.getChannelData(0),e.getChannelData(0)):(t=e.getChannelData(0),e.getChannelData(1));e=t.length;processAudioSegments(t,n,NUM_WORKERS,e)}):(console.log("Converting input file to MIDI directly"),packageAndDownloadMidiOnly(e))},t.readAsArrayBuffer(fileInput.files[0])}else{for(var t=folderInput.files,n=(trackProductEvent("Start Job",{mode:"batch",numWorkers:e}),"midi"!=processingMode&&initWorkers(),document.getElementById("inference-progress-bar").style.width="0%",document.getElementById("midi-progress-bar").style.width="0%",document.getElementById("output-links"));n.firstChild;)n.removeChild(n.firstChild);processFiles(t,"midi"===processingMode)}}).catch(e=>{console.error("Model initialization failed:",e)})}),prevStep2Btn.addEventListener("click",function(){step2.style.display="none",step1.style.display="block"}),prevStep3Btn.addEventListener("click",function(){step3.style.display="none",step2.style.display="block"}),nextStep3Btn.addEventListener("click",function(){resetUIElements(),step3.style.display="none",step1.style.display="block"}),[]),isProcessing=!1,midiWorker,midiWasmLoaded=!1,midiBuffers={},mxmlBuffers={},queueTotal=0,queueCompleted=0,completedSongsBatchMidi=0;function initializeMidiWorker(){(midiWorker=new Worker("basicpitch_worker.js")).onmessage=function(e){var t;"WASM_READY"===e.data.msg?(console.log("Basicpitch WASM module loaded successfully"),midiWasmLoaded=!0,processNextMidi()):"PROGRESS_UPDATE"===e.data.msg?(t=e.data.data,t=(queueCompleted+t)/queueTotal*100,document.getElementById("midi-progress-bar").style.width=t+"%"):"PROGRESS_UPDATE_BATCH"===e.data.msg?(t=e.data.data,t=(queueCompleted+t)/queueTotal*globalProgressIncrement,t=completedSongsBatchMidi*globalProgressIncrement+t,document.getElementById("midi-progress-bar").style.width=t+"%"):"PROCESSING_DONE"===e.data.msg?(queueCompleted+=1,handleMidiDone(e.data),isProcessing=!1,processNextMidi()):"PROCESSING_FAILED"===e.data.msg&&(console.error(`Failed to generate MIDI for ${e.data.stemName}.`),isProcessing=!1,processNextMidi())},midiWorker.postMessage({msg:"LOAD_WASM",scriptName:"basicpitch_mxml.js"})}function handleMidiDone(e){var{midiBytes:e,mxmlBytes:t,stemName:n}=e,e=new Blob([e],{type:"audio/midi"}),t=new Blob([t],{type:"application/xml"});midiBuffers[n]=e,mxmlBuffers[n]=t,console.log(`MIDI generation done for ${n}.`)}function queueMidiRequest(e,t,n,s=!1){midiQueue.push({audioBuffer:e,stemName:t,batchMode:n,directArrayBuffer:s}),queueTotal+=1,processNextMidi()}function processNextMidi(){var e,t,n,s;!isProcessing&&0!==midiQueue.length&&midiWasmLoaded&&(isProcessing=!0,{audioBuffer:e,stemName:t,batchMode:n,directArrayBuffer:s}=midiQueue.shift(),generateMidi(e,t,n,s))}function generateMidi(e,o,l,t=!1){t?basicpitchAudioContext.decodeAudioData(e,async e=>{var t=e.getChannelData(0),n=1<e.numberOfChannels?e.getChannelData(1):t,s=new Float32Array(t.length);for(let e=0;e<t.length;e++)s[e]=(t[e]+n[e])/2;midiWorker.postMessage({msg:"PROCESS_AUDIO",inputData:s.buffer,length:s.length,stemName:o,batchMode:l},[s.buffer])}):(t=encodeWavFileFromAudioBuffer(e,0),basicpitchAudioContext.decodeAudioData(t,async e=>{var t=e.getChannelData(0),n=1<e.numberOfChannels?e.getChannelData(1):t,s=new Float32Array(t.length);for(let e=0;e<t.length;e++)s[e]=(t[e]+n[e])/2;midiWorker.postMessage({msg:"PROCESS_AUDIO",inputData:s.buffer,length:s.length,stemName:o,batchMode:l},[s.buffer])}))}let midiStemNames=["vocals","bass","melody","other_melody","piano","guitar"];function generateBuffers(s,e,o,l,i){let t=e.filter(e=>"instrumental"!==e),d=("demucs-free-6s"!==o&&"demucs-pro-cust"!==o&&"demucs-pro-cust-spec"!==o||(t=t.filter(e=>"melody"!==e)),{});if(t.forEach((e,t)=>{var n=demucsAudioContext.createBuffer(2,s[0].length,DEMUCS_SAMPLE_RATE);n.copyToChannel(s[2*t],0),n.copyToChannel(s[2*t+1],1),d[e]=n,"stems"!==l&&i.includes(e)&&queueMidiRequest(n,e,!1)}),e.includes("instrumental"))if("demucs-karaoke"===o){var n=demucsAudioContext.createBuffer(2,s[0].length,DEMUCS_SAMPLE_RATE);n.copyToChannel(s[2],0),n.copyToChannel(s[3],1),d.instrumental=n}else{let n=demucsAudioContext.createBuffer(2,s[0].length,DEMUCS_SAMPLE_RATE);t.filter(e=>"vocals"!==e).forEach(e=>{if(!("demucs-pro-cust"===o&&["guitar","piano","other_melody"].includes(e))){var t=d[e];for(let e=0;e<s[0].length;e++)n.getChannelData(0)[e]+=t.getChannelData(0)[e]||0,n.getChannelData(1)[e]+=t.getChannelData(1)[e]||0}}),d.instrumental=n}if(e.includes("melody")&&("demucs-free-6s"===o||"demucs-pro-cust"===o||"demucs-pro-cust-spec"===o)){let n=demucsAudioContext.createBuffer(2,s[0].length,DEMUCS_SAMPLE_RATE);t.filter(e=>["other_melody","piano","guitar"].includes(e)).forEach(e=>{var t=d[e];for(let e=0;e<s[0].length;e++)n.getChannelData(0)[e]+=t.getChannelData(0)[e]||0,n.getChannelData(1)[e]+=t.getChannelData(1)[e]||0}),d.melody=n}return d}function packageAndDownload(e){"stems"==processingMode||midiWorker||initializeMidiWorker(),console.log(e);let t=generateBuffers(e,selectedStems,selectedModel,processingMode,midiStemNames);waitForMidiProcessing().then(()=>createDownloadLinks(t,!1))}function packageAndDownloadMidiOnly(e){console.log(`Processing ${e} bytes of audio data in MIDI-only mode`),"stems"==processingMode||midiWorker||initializeMidiWorker(),queueMidiRequest(e,"output",!1,!0),waitForMidiProcessing().then(()=>createDownloadLinks(null,!0))}function waitForMidiProcessing(){return new Promise(e=>{let t=()=>{0!==midiQueue.length||isProcessing?setTimeout(t,100):e()};t()})}function createDownloadLinks(s,e){var o=document.getElementById("output-links"),l=(o.innerHTML="",{}),i=[];e?(Object.keys(midiBuffers).forEach(function(n){i.push(midiBuffers[n].arrayBuffer().then(function(e){l[n+".mid"]=new Uint8Array(e);var e=URL.createObjectURL(midiBuffers[n]),t=document.createElement("a");t.href=e,t.textContent=n+".mid",t.download=n+".mid",o.appendChild(t)}))}),Object.keys(mxmlBuffers).forEach(function(n){i.push(mxmlBuffers[n].arrayBuffer().then(function(e){l[n+".mid"]=new Uint8Array(e);var e=URL.createObjectURL(mxmlBuffers[n]),t=document.createElement("a");t.href=e,t.textContent=n+".musicxml",t.download=n+".musicxml",o.appendChild(t)}))})):Object.keys(s).forEach(function(n){var e=encodeWavFileFromAudioBuffer(s[n],0),e=(l[n+".wav"]=new Uint8Array(e),new Blob([e],{type:"audio/wav"})),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.textContent=n+".wav",t.download=n+".wav",o.appendChild(t),midiBuffers[n]&&i.push(midiBuffers[n].arrayBuffer().then(function(e){l[n+".mid"]=new Uint8Array(e);var e=URL.createObjectURL(midiBuffers[n]),t=document.createElement("a");t.href=e,t.textContent=n+".mid",t.download=n+".mid",o.appendChild(t)})),mxmlBuffers[n]&&i.push(mxmlBuffers[n].arrayBuffer().then(function(e){l[n+".musicxml"]=new Uint8Array(e);var e=URL.createObjectURL(mxmlBuffers[n]),t=document.createElement("a");t.href=e,t.textContent=n+".musicxml",t.download=n+".musicxml",o.appendChild(t)}))}),Promise.all(i).then(function(){var e,t;0<Object.keys(l).length&&(e=fflate.zipSync(l,{level:0}),e=new Blob([e.buffer],{type:"application/zip"}),e=URL.createObjectURL(e),(t=document.createElement("a")).href=e,t.textContent="all_stems.zip",t.download="all_stems.zip",t.classList.add("supreme-zip-link"),o.firstChild?o.insertBefore(t,o.firstChild):o.appendChild(t)),midiBuffers={},mxmlBuffers={},queueTotal=0,queueCompleted=0,"stems"!=processingMode&&incrementUsage(),prevStep3Btn.disabled=!1,nextStep3Btn.disabled=!1})}async function processFiles(l,i){if(console.log(`Processing ${l.length} files; midi-only mode?: `+i),l&&0!==l.length){globalProgressIncrement=100/l.length;let n=0;i&&!midiWorker&&initializeMidiWorker();for(let t of l){let e=new FileReader;await new Promise(o=>{e.onload=async function(e){e=e.target.result;let s=t.name.slice(0,t.name.lastIndexOf("."));i?(queueMidiRequest(e,s,!1,!0),waitForMidiProcessing().then(()=>{var e=++n/l.length*100;document.getElementById("midi-progress-bar").style.width=e+"%",o()})):demucsAudioContext.decodeAudioData(e,e=>{let t,n;n=1===e.numberOfChannels?(t=e.getChannelData(0),e.getChannelData(0)):(t=e.getChannelData(0),e.getChannelData(1));e=t.length;processBatchSegments(t,n,NUM_WORKERS,s,e),batchNextFileResolveCallback=o})},e.readAsArrayBuffer(t)})}if(i){for(var e in console.log("All MIDI files processed."),midiBuffers){var t,s=midiBuffers[e];s&&(s=URL.createObjectURL(s),(t=document.createElement("a")).href=s,t.textContent=e+".mid",t.download=e+".mid",document.getElementById("output-links").appendChild(t))}midiBuffers={},queueTotal=0,queueCompleted=0,prevStep3Btn.disabled=!1,nextStep3Btn.disabled=!1}"stems"!=processingMode&&incrementUsage()}}function packageAndZip(e,n){"stems"==processingMode||midiWorker||initializeMidiWorker(),console.log(e);let s=generateBuffers(e,selectedStems,selectedModel,processingMode,midiStemNames),o=n+"_stems/",l={};Object.keys(s).forEach(e=>{var t=encodeWavFileFromAudioBuffer(s[e],0);l[o+e+".wav"]=new Uint8Array(t)}),waitForMidiProcessing().then(()=>Promise.all(Object.keys(midiBuffers).map(t=>midiBuffers[t].arrayBuffer().then(e=>{l[o+t+".mid"]=new Uint8Array(e)})))).then(()=>{var e=fflate.zipSync(l,{level:0}),e=new Blob([e.buffer],{type:"application/zip"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.textContent=n+"_stems.zip",t.download=n+"_stems.zip",document.getElementById("output-links").appendChild(t),midiBuffers={},queueTotal=0,queueCompleted=0,completedSongsBatchMidi<document.getElementById("batch-upload").files.length-1?completedSongsBatchMidi+=1:completedSongsBatchMidi=0,prevStep3Btn.disabled=!1,nextStep3Btn.disabled=!1})}function incrementUsage(){var e;"true"!==sessionStorage.getItem("loggedIn")&&((e=JSON.parse(localStorage.getItem("weeklyUsage"))).count+=1,localStorage.setItem("weeklyUsage",JSON.stringify(e)),checkAndResetWeeklyLimit())}